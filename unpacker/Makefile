# Copyright 2014 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# GNU Makefile based on shared rules provided by the Native Client SDK.
# See README.Makefiles for more details.

# In order to build with newlib by default change "pnacl newlib" to
# "newlib pnacl" or use make VAILD_TOOLCHAINS=newlib.
VALID_TOOLCHAINS := pnacl newlib

NACL_SDK_ROOT ?= $(abspath $(CURDIR)/../..)

include $(NACL_SDK_ROOT)/tools/common.mk

TARGET = module
LIBS = ppapi_cpp ppapi pthread archive z iconv

CFLAGS = -Wall
SOURCES = \
  cpp/module.cc \
  cpp/request.cc \
  cpp/volume.cc \
  cpp/volume_archive_libarchive.cc \
  cpp/volume_reader_javascript_stream.cc

# Build rules generated by macros from common.mk:

$(foreach src,$(SOURCES),$(eval $(call COMPILE_RULE,$(src),$(CFLAGS))))

# The PNaCl workflow uses both an unstripped and finalized/stripped binary.
# On NaCl, only produce a stripped binary for Release configs (not Debug).
ifneq (,$(or $(findstring pnacl,$(TOOLCHAIN)),$(findstring Release,$(CONFIG))))
$(eval $(call LINK_RULE,$(TARGET)_unstripped,$(SOURCES),$(LIBS),$(DEPS)))
$(eval $(call STRIP_RULE,$(TARGET),$(TARGET)_unstripped))
else
$(eval $(call LINK_RULE,$(TARGET),$(SOURCES),$(LIBS),$(DEPS)))
endif

$(eval $(call NMF_RULE,$(TARGET),))

# Debug rule for testing. make debug will try to run Chrome with index.html,
# but there is no index.html. Every rule that constains "debug" will build and
# use the debug executables (see #line 113 from $NACL_SDK_ROOT/tools/common.mk
# with findstring).
.PHONY: debug_for_tests
debug_for_tests: all

# Default script for gdb. Feel free to overwrite it from outside.
GDB_SCRIPT ?= gdb_script
GDB_ARGS += -D --eval-command="source $(GDB_SCRIPT)"

# Debug rule for gdb. The extension is automatically loaded at every run.
# Ignore the 404 error for index.html that appears in the browser when
# running this rule. The load is done automatically from the tools we use from
# $(NACL_SDK_ROOT)/tools/common.mk.
#
# In case you want to persistent the changes to Chrome between multiple runs of
# this rule close Chrome using "x" and not CTRL+C, else user-data-dir-gdb
# doesn't get updated.
#
# IMPORTANT: Overwrite CHROME_PATH variable with the path to the browser
# executable that supports the File System Provider API. Otherwise this will
# fallback to the default Chrome browser installed on the machine and fail.
# e.g.: export CHROME_PATH=~/chrome-dev/code/src/out/Release/chrome
.PHONY: debug_gdb
debug_gdb: check_for_chrome all
	$(RUN_PY) $(GDB_ARGS) \
	    -C $(CURDIR) \
	     $(addprefix -E ,$(CHROME_ENV)) -- $(CHROME_PATH_ESCAPE) \
	    --enable-nacl --enable-pnacl --enable-nacl-debug \
	    --disable-setuid-sandbox --no-sandbox \
	    --user-data-dir=user-data-dir-gdb --enable-loggining --v1 \
	    --load-extension=. \
	    --register-pepper-plugins="$(PPAPI_DEBUG),$(PPAPI_RELEASE)"
